@{
    ViewBag.Title = "Cập Nhật Tài Khoản Nhân Viên";
    Layout = "~/Views/Shared/_AdminPage.cshtml";
}

@section css {
    <!-- Kendo -->
    <link href="~/Kendo/styles/kendo.common.min.css" rel="stylesheet">
    <link href="~/Kendo/styles/kendo.material.min.css" rel="stylesheet">
    <!-- End Kendo -->
}

<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h3><font color="#1ABB9C">Cập Nhật Tài Khoản</font></h3>
                <div class="clearfix"></div>
            </div>
            <div class="x_content bg-white">
                <form method="post" class="form-horizontal form-label-left" novalidate>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="username">
                            Tên tài khoản <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtUserName" class="form-control col-md-7 col-xs-12" name="username" required="required" type="text">
                        </div>
                    </div>
                    <div id="divPassword" class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="password">
                            Mật khẩu <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtPassword" class="form-control col-md-7 col-xs-12" name="password" required="required" type="text">
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="fullname">
                            Họ và tên
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtFullName" class="form-control col-md-7 col-xs-12" name="fullname" type="text">
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">
                            Giới Tính
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12" style="padding-top:6px">
                            <div id="gender" class="btn-group" data-toggle="buttons">
                                <input type="radio" class="flat" name="gender" id="rdbMale" value="0" checked="" required /> Nam &nbsp;
                                <input type="radio" class="flat" name="gender" id="rdbFemale" value="1" /> Nữ
                            </div>
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="address">
                            Địa chỉ
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtUserAddress" class="form-control col-md-7 col-xs-12" name="address" type="text">
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="deskphoneno">
                            Điện thoại bàn
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtDeskphoneNo" class="form-control col-md-7 col-xs-12" name="deskphone" type="text">
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="softphoneno">
                            Điện thoại di động
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtPhoneNo" class="form-control col-md-7 col-xs-12" name="softphone" type="text">
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="emailaddress">
                            Địa chỉ email
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtEmailAddress" class="form-control col-md-7 col-xs-12" name="email" type="text">
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="skypeaccount">
                            Tài khoản Skype
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtSkypeAccount" class="form-control col-md-7 col-xs-12" name="skypeacc" type="text">
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">
                            Hiển thị
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12" style="padding-top:6px">
                            <div id="consultant" class="btn-group" data-toggle="buttons">
                                <input type="radio" class="flat" name="consultant" id="rdbYes" value="1" checked="" required /> Có &nbsp;
                                <input type="radio" class="flat" name="consultant" id="rdbNo" value="0" /> Không
                            </div>
                        </div>
                    </div>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">
                            Ảnh đại diện
                        </label>
                        <div class="col-md-3 col-sm-5 col-xs-12" style="padding-top:6px">
                            <input type='file' id="imgImageUpload" accept="image/x-png,image/gif,image/jpeg" />
                            <div style="padding-top:5px"><img id="divPreview" src="#" width="70%" height="170" alt="Hình ảnh được upload" style="display:none" /></div>
                        </div>
                    </div>
                    <div id="divLastUpdatedDate" class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">
                            Cập nhật lần cuối
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12" style="padding-top:8px">
                            <label id="lblLastUpdatedDate"></label>
                        </div>
                    </div>
                    <div id="divLastUpdatedBy" class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12">
                            Người cập nhật
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12" style="padding-top:8px">
                            <label id="lblLastUpdatedBy"></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-6 col-md-offset-3">
                            <button id="btnSave" type="submit" class="btn btn-success" onclick="return Save();">Lưu</button>
                            <button id="btnCancel" type="button" class="btn btn-primary" onclick="ClearInput()">Xoá</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        @*<div class="x_panel">
            <div class="x_title">
                <h3><font color="#1ABB9C">Tìm Kiếm</font></h3>
                <div class="clearfix"></div>
            </div>
            <div class="x_content bg-white">
                <form method="post" class="form-horizontal form-label-left" novalidate>
                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="keysearch">
                            Từ khoá
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input id="txtKeySearch" name="keysearch" type="text" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-6 col-md-offset-3">
                            <button id="btnSearch" type="button" class="btn btn-success" onclick="Search()">Tìm</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>*@
        <div class="x_panel">
            <div class="x_title">
                <h3><font color="#1ABB9C">Danh Sách Tài Khoản</font></h3>
                <div class="clearfix"></div>
            </div>
            <div class="x_content bg-white">
                <div id="grid_List_Account"></div>
            </div>
        </div>
        <div style="visibility:hidden">
            <label id="lblUserID"></label>
            <label id="lblUserImages"></label>
        </div>
    </div>
</div>

<div class="modal fade" id="myModalXoa">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="color:#fff; background-color:#37619C;">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Xoá Tài Khoản Nhân Viên</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="UserID_Del" />
                <span id="alertxoa">Bạn có chắc muốn xoá tài khoản nhân viên này?</span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-info" onclick="DeleteAccount()"><i class="ace-icon fa fa-trash bigger-40"></i> Xóa</button>
                <button type="button" class="btn btn-sm btn-danger" data-dismiss="modal"><i class="ace-icon fa fa-close bigger-70"></i> Huỷ</button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <!-- Kendo -->
    <script src="~/Kendo/js/jszip.min.js" type="text/javascript"></script>
    <script src="~/Kendo/js/kendo.all.min.js" type="text/javascript"></script>
    <!-- End Kendo -->
    <script>
        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#divPreview').attr('src', e.target.result);
                    $('#divPreview').attr('style', 'display:block');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        $("#imgImageUpload").change(function () {
            var val = $(this).val();
            switch (val.substring(val.lastIndexOf('.') + 1).toLowerCase()) {
                case 'gif': case 'jpg': case 'png':
                    readURL(this);
                    break;
                default:
                    $(this).val('');
                    ShowAlert('Thông báo', 'Tệp vừa được chọn không hợp lệ.\r\nVui lòng chọn đúng định dạng hình ảnh.', 'error');
                    break;
            }
        });
    </script>

    <script>
        $(document).ready(function () {
            $('#divLastUpdatedDate').attr('style', 'display:none');
            $('#divLastUpdatedBy').attr('style', 'display:none');
            $('#divPassword').attr('style', 'display:block');
            $('#lblUserID').text('');
            $('#lblUserImages').text('');
            OnLoadGridAccount();
        });

        function OnLoadGridAccount(key) {
            var dataSource = new kendo.data.DataSource({
                pageSize: 10,
                serverPaging: true,
                serverSorting: true,
                allowUnsort: true,
                sort: {
                    field: 'UserID',
                    dir: 'asc'
                },
                schema: {
                    model: {
                        id: "UserID",
                        fields: {
                            UserID: { type: "number", editable: false, nullable: true },
                            UserName: { type: "string", editable: false, nullable: true },
                            FullName: { type: "string", editable: false, nullable: true },
                            OriginalPassword: { type: "string", editable: false, nullable: true },
                            Gender: { type: "bool", editable: false, nullable: true },
                            UserAddress: { type: "string", editable: false, nullable: true },
                            DeskphoneNo: { type: "string", editable: false, nullable: true },
                            PhoneNo: { type: "string", editable: false, nullable: true },
                            EmailAddress: { type: "string", editable: false, nullable: true },
                            SkypeAccount: { type: "string", editable: false, nullable: true },
                            IsConsultant: { type: "bool", editable: false, nullable: true },
                            IsActive: { type: "bool", editable: false, nullable: true },
                            UserImage: { type: "string", editable: false, nullable: true },
                            CreatedBy: { type: "string", editable: false, nullable: true },
                            CreatedDate: { type: "string", editable: false, nullable: true },
                            LastUpdatedBy: { type: "string", editable: false, nullable: true },
                            LastUpdatedDate: { type: "string", editable: false, nullable: true },
                        }
                    },
                    data: 'records',
                    total: 'total'
                },
                transport: {
                    read: {
                        contentType: "application/json; charset=utf-8",
                        url: "/Admin/Select_List_Account",
                        type: 'POST',
                        dataType: "json"
                    },
                    parameterMap: function (options, operation) {
                        if (operation == "read") {
                            return JSON.stringify(options);
                        }
                    }
                }
            });

            $("#grid_List_Account").kendoGrid({
                dataSource: dataSource,
                noRecords: true,
                messages: {
                    noRecords: "Không có kết quả nào được tìm thấy!"
                },
                sortable: true,
                scrollable: true,
                pageable: {
                    buttonCount: 3,
                    input: true,
                    messages: {
                        display: 'Dòng {0} - {1} / {2} dòng',
                        empty: 'Không có dữ liệu',
                        first: 'Trang đầu',
                        itemsPerPage: 'dòng / trang',
                        last: 'Trang cuối',
                        next: 'Trang sau',
                        of: '/ {0} trang',
                        page: 'Trang',
                        previous: 'Trang trước'
                    },
                    pageSize: 10,
                    pageSizes: [10, 20, 50]
                },
                selectable: "row",
                columns: [
                //{
                //    field: "UserID",
                //    title: "STT",
                //    width: 50,
                //    attributes: { style: "text-align: center; vertical-align: middle; ", },
                //    headerAttributes: {
                //        style: "text-align: center; vertical-align: middle; font-weight:bold;",
                //    }
                //},
                {
                    field: "FullName",
                    title: "Họ và tên",
                    width: 200,
                    headerAttributes: {
                        style: "text-align: center; vertical-align: middle; font-weight:bold;",
                    }
                },
                {
                    field: "UserAddress",
                    title: "Địa chỉ",
                    width: 350,
                    headerAttributes: {
                        style: "text-align: center; vertical-align: middle; font-weight:bold;",
                    }
                },
                {
                    field: "EmailAddress",
                    title: "Email",
                    width: 200,
                    headerAttributes: {
                        style: "text-align: center; vertical-align: middle; font-weight:bold;",
                    }
                },
                {
                    field: "PhoneNo",
                    title: "Di động",
                    width: 100,
                    attributes: { class: "canhgiua" },
                    headerAttributes: {
                        style: "text-align: center; vertical-align: middle; font-weight:bold;",
                    }
                },
                {
                    width: 150,
                    template: "<a onclick='ShowUpdate(#= UserID #);' class='btn btn-xs btn-danger'><i class='ace-icon fa fa-trash bigger-40'></i> Sửa</a>" + "# if (UserName == 'SystemAdmin') { #" + "# } else { #" + "<a onclick='ShowDelete(#= UserID #);' class='btn btn-xs btn-info'><i class='ace-icon fa fa-edit bigger-40'></i>&nbsp;&nbsp;Xoá</a>" + "# } #",
                    attributes: { style: "text-align: center; vertical-align: middle; ", },
                    headerAttributes: {
                        style: "text-align: center; vertical-align: middle; font-weight:bold;",
                    }
                }]
            }).data("kendoGrid");
        }

        function Search()
        {

        }

        function Save()
        {
            if ($.trim($('#txtUserName').val()) != '' && $.trim($('#txtPassword').val()) != '')
            {
                if ($('#lblUserID').text() == "" && $.trim($('#txtPassword').val()) != '')
                {
                    SaveAccount();
                    return false;
                }
                else
                {
                    UpdateAccount();
                    return false;
                }
            }
        }

        function SaveAccount() {
            $('#loading').fadeIn();
            var fd = new FormData();
            var files = $('#imgImageUpload').get(0).files;
            if (files.length > 0)
            {
                fd.append("ImageFile", files[0]);
            }
            else
            {
                fd.append("UserImage", "No Image");
            }
            fd.append("UserName", $('#txtUserName').val());
            fd.append("Password", $('#txtPassword').val());
            fd.append("FullName", $('#txtFullName').val());
            if (document.getElementById('rdbMale').checked)
            {
                fd.append("Gender", false);
            }
            else
            {
                fd.append("Gender", true);
            }
            fd.append("UserAddress", $('#txtUserAddress').val());
            fd.append("DeskphoneNo", $('#txtDeskphoneNo').val());
            fd.append("PhoneNo", $('#txtPhoneNo').val());
            fd.append("EmailAddress", $('#txtEmailAddress').val());
            fd.append("SkypeAccount", $('#txtSkypeAccount').val());
            if (document.getElementById('rdbNo').checked) {
                fd.append("IsConsultant", false);
            }
            else {
                fd.append("IsConsultant", true);
            }
            fd.append("LOAI", "INSERT");

            $.ajax({
                type: 'POST',
                url: '/Admin/CapNhatTaiKhoan',
                data: fd,
                contentType: false,
                processData: false,
                success: function (html) {
                    $('#loading').fadeOut();
                    if (html == "...") {
                        $(':input')
                            .removeAttr('checked')
                            .removeAttr('selected')
                            .not(':button, :submit, :reset, :hidden, :radio, :checkbox')
                            .val('');
                        $('#grid_List_Account').data('kendoGrid').dataSource.read();
                        ClearInput();
                        ShowAlert('Thông báo', 'Cập nhật thành công!', 'success');
                    }
                    else {
                        ShowAlert('Lỗi', html, 'error');
                    }
                },
            })
            .fail(
                function (jqXHR, textStatus, err) {
                    $('#loading').fadeOut();
                    ShowAlert('Lỗi', err, 'error');
                }
            );
        }

        function ShowUpdate(UserID) {
            var grid_data = $("#grid_List_Account").data("kendoGrid"),
            data = grid_data.dataSource.data();

            var res = $.grep(data, function (d) {
                return d.UserID == UserID;
            });

            $('#lblUserID').text(UserID);
            $('#txtUserName').val(res[0].UserName);
            if (res[0].UserName == 'SystemAdmin') {
                document.getElementById("txtUserName").disabled = true;
            }
            else {
                document.getElementById("txtUserName").disabled = false;
            }
            $('#txtFullName').val(res[0].FullName);
            $('#txtPassword').val(res[0].OriginalPassword);
            $('#txtUserAddress').val(res[0].UserAddress);
            $('#txtDeskphoneNo').val(res[0].DeskphoneNo);
            $('#txtPhoneNo').val(res[0].PhoneNo);
            $('#txtEmailAddress').val(res[0].EmailAddress);
            $('#txtSkypeAccount').val(res[0].SkypeAccount);
            if (res[0].Gender == false)
            {
                document.getElementById("rdbMale").checked = true;
            }
            else {
                document.getElementById("rdbFemale").checked = true;
            }
            if (res[0].IsConsultant == false) {
                document.getElementById("rdbNo").checked = true;
            }
            else {
                document.getElementById("rdbYes").checked = true;
            }
            $('#lblUserImages').text(res[0].UserImage);
            var path = "../../" + res[0].UserImage;
            $('#divPreview').attr('src', path);
            $('#divPreview').attr('style', 'display:block');
            $('#divLastUpdatedDate').attr('style', 'display:block');
            $('#divLastUpdatedBy').attr('style', 'display:block');
            if (res[0].LastUpdatedDate == "" || res[0].LastUpdatedDate == null) {
                $('#lblLastUpdatedDate').text(res[0].CreatedDate);
            }
            else {
                $('#lblLastUpdatedDate').text(res[0].LastUpdatedDate);
            }
            if (res[0].LastUpdatedBy == "" || res[0].LastUpdatedBy == null) {
                $('#lblLastUpdatedBy').text(res[0].CreatedBy);
            }
            else {
                $('#lblLastUpdatedBy').text(res[0].LastUpdatedBy);
            }
        };

        function UpdateAccount() {
            $('#loading').fadeIn();
            var fd = new FormData();
            var files = $('#imgImageUpload').get(0).files;
            if (files.length > 0) {
                fd.append("ImageFile", files[0]);
            }
            else {
                fd.append("UserImage", document.getElementById('lblUserImages').innerHTML);
            }
            fd.append("UserID", $('#lblUserID').text());
            fd.append("UserName", $('#txtUserName').val());
            fd.append("Password", $('#txtPassword').val());
            fd.append("FullName", $('#txtFullName').val());
            if (document.getElementById('rdbMale').checked) {
                fd.append("Gender", false);
            }
            else {
                fd.append("Gender", true);
            }
            fd.append("UserAddress", $('#txtUserAddress').val());
            fd.append("DeskphoneNo", $('#txtDeskphoneNo').val());
            fd.append("PhoneNo", $('#txtPhoneNo').val());
            fd.append("EmailAddress", $('#txtEmailAddress').val());
            fd.append("SkypeAccount", $('#txtSkypeAccount').val());
            if (document.getElementById('rdbNo').checked) {
                fd.append("IsConsultant", false);
            }
            else {
                fd.append("IsConsultant", true);
            }
            fd.append("LOAI", "UPDATE");

            $.ajax({
                type: 'POST',
                url: '/Admin/CapNhatTaiKhoan',
                data: fd,
                contentType: false,
                processData: false,
                success: function (html) {
                    $('#loading').fadeOut();
                    if (html == "...") {
                        $(':input')
                            .removeAttr('checked')
                            .removeAttr('selected')
                            .not(':button, :submit, :reset, :hidden, :radio, :checkbox')
                            .val('');
                        $('#lblUserID').text('');
                        $('#lblUserImages').text('');
                        $('#divLoginTime').attr('style', 'display:none');
                        $('#divLastUpdatedDate').attr('style', 'display:none');
                        $('#divLastUpdatedBy').attr('style', 'display:none');
                        $('#grid_List_Account').data('kendoGrid').dataSource.read();
                        ClearInput();
                        ShowAlert('Thông báo', 'Cập nhật thành công!', 'success');
                    }
                    else {
                        ShowAlert('Lỗi', html, 'error');
                    }
                },
            })
            .fail(
                function (jqXHR, textStatus, err) {
                    $('#loading').fadeOut();
                    ShowAlert('Lỗi', err, 'error');
                }
            );
        }

        function ShowDelete(UserID) {
            $('#UserID_Del').val(UserID);

            $('#myModalXoa').appendTo("body").modal('show');
        }

        function DeleteAccount() {
            $('#myModalXoa').modal('hide');
            $('#loading').fadeIn();
            var fd = new FormData();
            fd.append("UserID", $('#UserID_Del').val());
            fd.append("LOAI", "DELETE");

            $.ajax({
                type: 'POST',
                url: '/Admin/CapNhatTaiKhoan',
                data: fd,
                contentType: false,
                processData: false,
                success: function (html) {
                    $('#loading').fadeOut();
                    if (html == "...") {
                        $(':input')
                            .removeAttr('checked')
                            .removeAttr('selected')
                            .not(':button, :submit, :reset, :hidden, :radio, :checkbox')
                            .val('');
                        $('#grid_List_Account').data('kendoGrid').dataSource.read();
                        ShowAlert('Thông báo', 'Cập nhật thành công!', 'success');
                    }
                    else {
                        ShowAlert('Lỗi', html, 'error');
                    }
                },
            })
            .fail(
                function (jqXHR, textStatus, err) {
                    $('#loading').fadeOut();
                    ShowAlert('Lỗi', err, 'error');
                }
            );
        };

        function ClearInput() {
            document.getElementById("txtUserName").value = "";
            document.getElementById("txtPassword").value = "";
            document.getElementById("txtFullName").value = "";
            document.getElementById("rdbMale").checked = true;
            document.getElementById("txtUserAddress").value = "";
            document.getElementById("txtDeskphoneNo").value = "";
            document.getElementById("txtPhoneNo").value = "";
            document.getElementById("txtEmailAddress").value = "";
            document.getElementById("txtSkypeAccount").value = "";
            document.getElementById("rdbYes").checked = true;
            document.getElementById("imgImageUpload").value = "";
            $('#divPreview').attr('style', 'display:none');
            $('#lblUserID').text('');
            $('#lblUserImages').text('');
            $('#divLastUpdatedDate').attr('style', 'display:none');
            $('#divLastUpdatedBy').attr('style', 'display:none');
            $('#divPassword').attr('style', 'display:block');
        };
    </script>
}